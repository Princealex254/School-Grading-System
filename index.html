<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Academy Grading System</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for performance graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- HTML2PDF CDN for report generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Tailwind blue-600 */
        }
        .nav-link {
            color: #4a5568; /* Tailwind gray-700 */
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .nav-link:hover {
            background-color: #f1f5f9; /* Tailwind gray-100 */
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Tailwind gray-200 */
        }
        th {
            background-color: #f8fafc; /* Tailwind gray-50 */
            font-weight: 600;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0; /* Tailwind gray-200 */
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; /* Tailwind blue-500 */
        }
        /* Styles for the PDF report */
        .report-container {
            max-width: 21cm; /* A4 width */
            margin: auto;
            background-color: white;
            padding: 2rem;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
        }
        .report-header {
            background-color: #1e3a8a; /* Dark blue */
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .report-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .report-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .report-header p {
            font-size: 0.875rem;
            margin-top: 5px;
        }
        .report-footer {
            background-color: #1e3a8a;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            margin-top: 2rem;
        }
        .report-table th, .report-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .report-details {
            font-size: 1rem;
            color: #4b5563;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .signature-line {
            border-bottom: 1px solid #000;
            width: 150px;
            margin-top: 30px;
        }
        @media print {
            .no-print {
                display: none !important;
            }
        }
        .page-break {
            page-break-after: always;
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800">

    <!-- Main application container -->
    <div id="app-container" class="container mx-auto p-4 md:p-8"></div>

    <script>
        // --- Helper Functions and Initial Data Setup ---

        // Get or initialize data from localStorage
        const getData = (key, defaultValue) => {
            try {
                const storedData = localStorage.getItem(key);
                return storedData ? JSON.parse(storedData) : defaultValue;
            } catch (e) {
                console.error(`Error parsing data from localStorage for key: ${key}`, e);
                return defaultValue;
            }
        };

        const setData = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
        };

        const classes = ['Form 1', 'Form 2', 'Form 3', 'Form 4'];
        const currentYear = new Date().getFullYear();
        const academicYears = Array.from({ length: 5 }, (_, i) => (currentYear - 2 + i).toString()); // e.g., 2023, 2024, 2025, 2026, 2027

        // Updated grading scale
        const getGrade = (mark) => {
            if (mark >= 90) return 'A';
            if (mark >= 80) return 'B';
            if (mark >= 70) return 'C';
            if (mark >= 60) return 'D';
            return 'F';
        };

        // Pre-populate localStorage with some dummy data for a complete experience
        const initialSetup = () => {
            // Check if any data exists to avoid overwriting on refresh
            if (!localStorage.getItem('teachers')) {
                const dummyTeachers = [
                    { username: 'john.doe', password: 'password123', name: 'John Doe' },
                    { username: 'jane.smith', password: 'password123', name: 'Jane Smith' },
                ];
                setData('teachers', dummyTeachers);
            }

            if (!localStorage.getItem('students')) {
                const dummyStudents = [
                    { id: 'S001', name: 'Alice Johnson', class: 'Form 1', gender: 'Female', dob: '2010-05-15', parentName: 'Mr. Johnson', parentContact: '111-222-3333', behaviorNotes: 'Excellent conduct.', awards: ['Mathlete 2024'] },
                    { id: 'S002', name: 'Bob Williams', class: 'Form 1', gender: 'Male', dob: '2010-03-20', parentName: 'Ms. Williams', parentContact: '444-555-6666', behaviorNotes: 'Active participant.', awards: [] },
                    { id: 'S003', name: 'Charlie Brown', class: 'Form 2', gender: 'Male', dob: '2009-09-01', parentName: 'Mrs. Brown', parentContact: '777-888-9999', behaviorNotes: 'Needs to focus more in class.', awards: [] },
                    { id: 'S004', name: 'Diana Miller', class: 'Form 2', gender: 'Female', dob: '2009-01-10', parentName: 'Mr. Miller', parentContact: '000-111-2222', behaviorNotes: 'Consistently high effort.', awards: ['Science Fair Winner'] },
                    { id: 'S005', name: 'Evan Green', class: 'Form 3', gender: 'Male', dob: '2008-07-22', parentName: 'Ms. Green', parentContact: '333-444-5555', behaviorNotes: 'Good progress this term.', awards: [] },
                    { id: 'S006', name: 'Fiona White', class: 'Form 3', gender: 'Female', dob: '2008-04-05', parentName: 'Mr. White', parentContact: '666-777-8888', behaviorNotes: 'Excellent leadership skills.', awards: [] },
                    { id: 'S007', name: 'George Evans', class: 'Form 4', gender: 'Male', dob: '2007-11-30', parentName: 'Mrs. Evans', parentContact: '999-000-1111', behaviorNotes: 'Consistent academic performance.', awards: ['Debate Team Captain'] },
                    { id: 'S008', name: 'Hannah Davis', class: 'Form 4', gender: 'Female', dob: '2007-02-18', parentName: 'Mr. Davis', parentContact: '222-333-4444', behaviorNotes: 'Always willing to help others.', awards: [] },
                ];
                setData('students', dummyStudents);
            }

            if (!localStorage.getItem('admin')) {
                const dummyAdmin = { username: 'admin', password: 'adminpass' };
                setData('admin', dummyAdmin);
            }

            // Marks data will be added by the teacher
            if (!localStorage.getItem('marks')) {
                 const dummyMarks = [
                    // Term 1, Mid-Term, 2025
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'Mathematics', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 85, teacher: 'john.doe' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'Mathematics', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 78, teacher: 'john.doe' },
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'English', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 92, teacher: 'jane.smith' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'English', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 88, teacher: 'jane.smith' },
                    { studentId: 'S003', studentName: 'Charlie Brown', class: 'Form 2', subject: 'Science', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 65, teacher: 'john.doe' },
                    { studentId: 'S004', studentName: 'Diana Miller', class: 'Form 2', subject: 'Science', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 95, teacher: 'john.doe' },
                    { studentId: 'S005', studentName: 'Evan Green', class: 'Form 3', subject: 'Mathematics', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 70, teacher: 'john.doe' },
                    { studentId: 'S005', studentName: 'Evan Green', class: 'Form 3', subject: 'English', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 80, teacher: 'jane.smith' },
                    { studentId: 'S007', studentName: 'George Evans', class: 'Form 4', subject: 'Physics', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 90, teacher: 'john.doe' },
                    { studentId: 'S008', studentName: 'Hannah Davis', class: 'Form 4', subject: 'Chemistry', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 85, teacher: 'jane.smith' },
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'Science', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 88, teacher: 'john.doe' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'Science', term: 'Term 1', year: '2025', examType: 'Mid-Term', marks: 82, teacher: 'john.doe' },
                    // Term 1, End of Term, 2025
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'Mathematics', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 95, teacher: 'john.doe' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'Mathematics', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 82, teacher: 'john.doe' },
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'English', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 95, teacher: 'jane.smith' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'English', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 90, teacher: 'jane.smith' },
                    { studentId: 'S003', studentName: 'Charlie Brown', class: 'Form 2', subject: 'Science', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 75, teacher: 'john.doe' },
                    { studentId: 'S004', studentName: 'Diana Miller', class: 'Form 2', subject: 'Science', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 98, teacher: 'john.doe' },
                    { studentId: 'S005', studentName: 'Evan Green', class: 'Form 3', subject: 'Mathematics', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 75, teacher: 'john.doe' },
                    { studentId: 'S005', studentName: 'Evan Green', class: 'Form 3', subject: 'English', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 85, teacher: 'jane.smith' },
                    { studentId: 'S007', studentName: 'George Evans', class: 'Form 4', subject: 'Physics', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 92, teacher: 'john.doe' },
                    { studentId: 'S008', studentName: 'Hannah Davis', class: 'Form 4', subject: 'Chemistry', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 88, teacher: 'jane.smith' },
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'Science', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 90, teacher: 'john.doe' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'Science', term: 'Term 1', year: '2025', examType: 'End of Term', marks: 85, teacher: 'john.doe' },

                    // Term 2, Mid-Term, 2025
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'Mathematics', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 88, teacher: 'john.doe' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'Mathematics', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 75, teacher: 'john.doe' },
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'English', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 90, teacher: 'jane.smith' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'English', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 85, teacher: 'jane.smith' },
                    { studentId: 'S003', studentName: 'Charlie Brown', class: 'Form 2', subject: 'Science', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 70, teacher: 'john.doe' },
                    { studentId: 'S004', studentName: 'Diana Miller', class: 'Form 2', subject: 'Science', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 90, teacher: 'john.doe' },
                    { studentId: 'S005', studentName: 'Evan Green', class: 'Form 3', subject: 'Mathematics', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 78, teacher: 'john.doe' },
                    { studentId: 'S005', studentName: 'Evan Green', class: 'Form 3', subject: 'English', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 88, teacher: 'jane.smith' },
                    { studentId: 'S007', studentName: 'George Evans', class: 'Form 4', subject: 'Physics', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 85, teacher: 'john.doe' },
                    { studentId: 'S008', studentName: 'Hannah Davis', class: 'Form 4', subject: 'Chemistry', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 90, teacher: 'jane.smith' },
                    { studentId: 'S001', studentName: 'Alice Johnson', class: 'Form 1', subject: 'Science', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 85, teacher: 'john.doe' },
                    { studentId: 'S002', studentName: 'Bob Williams', class: 'Form 1', subject: 'Science', term: 'Term 2', year: '2025', examType: 'Mid-Term', marks: 79, teacher: 'john.doe' },
                ];
                setData('marks', dummyMarks);
            }

            if (!localStorage.getItem('fees')) {
                const dummyFees = [
                    { studentId: 'S001', term: 'Term 1', year: '2025', amountDue: 50000, amountPaid: 50000, status: 'Paid', date: '2025-01-10' },
                    { studentId: 'S002', term: 'Term 1', year: '2025', amountDue: 50000, amountPaid: 45000, status: 'Partial', date: '2025-01-15' },
                    { studentId: 'S003', term: 'Term 1', year: '2025', amountDue: 50000, amountPaid: 0, status: 'Pending', date: '' },
                    { studentId: 'S001', term: 'Term 2', year: '2025', amountDue: 50000, amountPaid: 25000, status: 'Partial', date: '2025-05-01' },
                ];
                setData('fees', dummyFees);
            }

            if (!localStorage.getItem('files')) {
                setData('files', []); // For mock file uploads
            }
        };

        // --- Core Application Logic ---

        const appContainer = document.getElementById('app-container');

        // Function to handle login (modified for direct sign-in)
        const login = (role) => {
            let user = {};
            if (role === 'teacher') {
                // For demo, just set a dummy teacher session
                user = { username: 'demo.teacher', name: 'Demo Teacher', role: 'teacher' };
            } else if (role === 'admin') {
                // For demo, just set a dummy admin session
                user = { username: 'admin', name: 'Admin User', role: 'admin' };
            }

            setData('session', user);
            renderPage();
            return true;
        };

        // Function to handle logout
        const logout = () => {
            localStorage.removeItem('session');
            renderPage();
        };

        // Function to toggle sidebar visibility
        const toggleSidebar = (role) => {
            const sidebar = document.getElementById(`${role}-sidebar`);
            const overlay = document.getElementById(`${role}-sidebar-overlay`);
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }
        };

        // Helper to calculate average marks for a student for a given term/year
        const calculateStudentAverage = (studentId, term, year) => {
            const allMarks = getData('marks', []);
            const studentMarks = allMarks.filter(m => m.studentId === studentId && m.term === term && m.year === year);
            
            const subjects = [...new Set(studentMarks.map(m => m.subject))];
            let totalFinalMarks = 0;
            let subjectCount = 0;

            subjects.forEach(subject => {
                const midTermMark = studentMarks.find(m => m.subject === subject && m.examType === 'Mid-Term');
                const endTermMark = studentMarks.find(m => m.subject === subject && m.examType === 'End of Term');
                const midTermScore = midTermMark ? midTermMark.marks : null;
                const endTermScore = endTermMark ? endTermMark.marks : null;
                
                let finalMark;
                if (midTermScore !== null && endTermScore !== null) {
                    finalMark = (midTermScore + endTermScore) / 2;
                } else {
                    finalMark = midTermScore || endTermScore;
                }
                if (finalMark !== null) {
                    totalFinalMarks += finalMark;
                    subjectCount++;
                }
            });

            return subjectCount > 0 ? totalFinalMarks / subjectCount : 0;
        };

        // --- Page Rendering Functions ---

        // Render the landing page
        const renderLandingPage = () => {
            appContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-400 to-indigo-600 p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-3xl w-full text-center transform transition-all duration-300 hover:scale-105">
                        <img src="logo.png" alt="School Logo" class="mx-auto mb-8 w-32 h-32 rounded-full border-4 border-blue-200 shadow-lg">
                        <h1 class="text-5xl md:text-6xl font-extrabold text-gray-800 mb-4 leading-tight">
                            Prince Alex Academy
                            <span class="block text-blue-600 text-4xl md:text-5xl mt-2">Grading System</span>
                        </h1>
                        <p class="text-xl md:text-2xl text-gray-600 mb-10 font-light">
                            Empowering educators and students through seamless grade management.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <button onclick="login('teacher')" class="group flex flex-col items-center justify-center p-6 bg-blue-500 text-white rounded-xl shadow-lg hover:bg-blue-600 transform hover:-translate-y-2 transition-all duration-300 ease-in-out cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-3 text-blue-100 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h-5v-2a3 3 0 013-3h2a3 3 0 013 3v2h-5z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 14v1m0 4v1m-4-7h1m4 0h1m-7 4h1m4 0h1m-7 4h1m4 0h1" />
                                </svg>
                                <span class="text-3xl font-bold">Teacher</span>
                                <span class="text-lg mt-1 opacity-90">Manage Grades & Reports</span>
                            </button>
                            <button onclick="login('admin')" class="group flex flex-col items-center justify-center p-6 bg-indigo-500 text-white rounded-xl shadow-lg hover:bg-indigo-600 transform hover:-translate-y-2 transition-all duration-300 ease-in-out cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-3 text-indigo-100 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.055 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.001 12.001 0 002 12c0 2.757 1.125 5.225 2.938 7.072M12 21.025V14" />
                                </svg>
                                <span class="text-3xl font-bold">Admin</span>
                                <span class="text-lg mt-1 opacity-90">System & User Management</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // Render the login page for a specific role (now directly logs in)
        const renderLoginPage = (role) => {
            // Directly call login function as per the new requirement
            login(role);
        };

        // Render the teacher dashboard
        const renderTeacherDashboard = () => {
            const session = getData('session', {});
            const students = getData('students', []);
            const marks = getData('marks', []);
            const currentAcademicYear = new Date().getFullYear().toString();
            const currentTerm = 'Term 1'; // Assuming a default current term for ranking display

            // Calculate top 5 students for the current term and year
            const studentAverages = students.map(student => ({
                ...student,
                average: calculateStudentAverage(student.id, currentTerm, currentAcademicYear)
            })).filter(s => s.average > 0); // Only include students with marks

            studentAverages.sort((a, b) => b.average - a.average);
            const top5Students = studentAverages.slice(0, 5);

            appContainer.innerHTML = `
                <div class="flex flex-col md:flex-row min-h-screen bg-blue-50">
                    <!-- Sidebar Navigation -->
                    <aside id="teacher-sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out w-64 bg-white p-6 shadow-lg z-50 md:rounded-r-none md:rounded-l-lg rounded-lg">
                        <div class="flex items-center mb-6">
                            <img src="logo.png" alt="School Logo" class="w-10 h-10 rounded-full mr-3">
                            <span class="text-xl font-bold text-blue-600">PAAGS</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Teacher Menu</h3>
                        <nav class="space-y-2">
                            <a href="#" onclick="renderTeacherDashboard()" class="block nav-link bg-blue-100 text-blue-700 font-semibold">Dashboard</a>
                            <a href="#" onclick="renderEnterMarksPage()" class="block nav-link">Enter Marks</a>
                            <a href="#" onclick="renderViewEditMarksPage()" class="block nav-link">View/Edit Marks</a>
                            <a href="#" onclick="renderStudentPerformancePage()" class="block nav-link">Student Performance</a>
                            <a href="#" onclick="renderAddStudentPage()" class="block nav-link">Add Student</a>
                            <a href="#" onclick="renderManageStudentProfilesPage()" class="block nav-link">Manage Student Profiles</a>
                            <a href="#" onclick="renderGenerateReportsPage()" class="block nav-link">Generate Reports</a>
                            <a href="#" onclick="renderFileUploadPage()" class="block nav-link">File Uploads</a>
                        </nav>
                        <div class="mt-8">
                             <button onclick="logout()" class="btn-primary w-full text-center">Logout</button>
                        </div>
                    </aside>

                    <!-- Overlay for mobile sidebar -->
                    <div id="teacher-sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-40 hidden md:hidden" onclick="toggleSidebar('teacher')"></div>

                    <!-- Main Content Area -->
                    <div class="flex-1 flex flex-col">
                        <!-- Mobile menu button -->
                        <button id="teacher-menu-btn" class="md:hidden p-2 rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 m-4 self-start">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                        <main class="flex-1 p-6 bg-white shadow-lg rounded-lg md:rounded-l-none">
                            <div id="teacher-content">
                                <h2 class="text-4xl font-bold text-gray-800 mb-2">Welcome, ${session.name}!</h2>
                                <p class="text-gray-600 mb-6">This is your teacher dashboard. Use the navigation to manage student grades.</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                    <div class="card bg-blue-50">
                                        <h3 class="text-2xl font-semibold text-blue-600 mb-2">Enter Marks</h3>
                                        <p class="text-gray-600">Add new marks for your students.</p>
                                        <button onclick="renderEnterMarksPage()" class="btn-primary mt-4">Go to Page</button>
                                    </div>
                                    <div class="card bg-blue-50">
                                        <h3 class="text-2xl font-semibold text-blue-600 mb-2">View & Edit Marks</h3>
                                        <p class="text-gray-600">Review and modify existing grades.</p>
                                        <button onclick="renderViewEditMarksPage()" class="btn-primary mt-4">Go to Page</button>
                                    </div>
                                    <div class="card bg-blue-50">
                                        <h3 class="text-2xl font-semibold text-blue-600 mb-2">Add Student</h3>
                                        <p class="text-gray-600">Add new students to the system.</p>
                                        <button onclick="renderAddStudentPage()" class="btn-primary mt-4">Go to Page</button>
                                    </div>
                                </div>

                                <h3 class="text-3xl font-bold text-gray-800 mb-6">Top 5 Students (${currentTerm}, ${currentAcademicYear})</h3>
                                <div class="card">
                                    <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average Score</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${top5Students.length > 0 ? top5Students.map((s, index) => `
                                                <tr>
                                                    <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap">${s.name}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap">${s.class}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap">${s.average.toFixed(2)}%</td>
                                                </tr>
                                            `).join('') : `
                                                <tr>
                                                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">No top students to display for this term/year.</td>
                                                </tr>
                                            `}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            `;
            // Attach event listener for mobile menu button
            document.getElementById('teacher-menu-btn').addEventListener('click', () => toggleSidebar('teacher'));
        };
        
        const renderAddStudentPage = () => {
            const contentDiv = document.getElementById('teacher-content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Add New Student</h2>
                    <form id="add-student-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="student-id" class="block text-sm font-medium text-gray-700">Admission No.</label>
                                <input type="text" id="student-id" placeholder="e.g., S009" class="input-field mt-1" required>
                            </div>
                            <div>
                                <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                                <input type="text" id="student-name" placeholder="e.g., Peter Jones" class="input-field mt-1" required>
                            </div>
                            <div>
                                <label for="student-class" class="block text-sm font-medium text-gray-700">Class</label>
                                <select id="student-class" class="input-field mt-1" required>
                                    <option value="">Select Class</option>
                                    ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="student-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                                <select id="student-gender" class="input-field mt-1" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div>
                                <label for="student-dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                <input type="date" id="student-dob" class="input-field mt-1">
                            </div>
                            <div>
                                <label for="parent-name" class="block text-sm font-medium text-gray-700">Parent/Guardian Name</label>
                                <input type="text" id="parent-name" class="input-field mt-1">
                            </div>
                            <div>
                                <label for="parent-contact" class="block text-sm font-medium text-gray-700">Parent/Guardian Contact</label>
                                <input type="text" id="parent-contact" class="input-field mt-1" placeholder="e.g., 0712345678">
                            </div>
                            <div>
                                <label for="behavior-notes" class="block text-sm font-medium text-gray-700">Behavior Notes</label>
                                <textarea id="behavior-notes" class="input-field mt-1" rows="2"></textarea>
                            </div>
                            <div>
                                <label for="awards" class="block text-sm font-medium text-gray-700">Awards (comma-separated)</label>
                                <input type="text" id="awards" class="input-field mt-1" placeholder="e.g., Mathlete 2024, Best in Science">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary w-full md:w-auto">Add Student</button>
                    </form>

                    <h3 class="text-2xl font-bold text-gray-800 mt-8 mb-4">Import Students (CSV)</h3>
                    <div class="card bg-gray-50 p-4">
                        <p class="text-gray-600 mb-2">Upload a CSV file with student data. The CSV should have columns: Admission No.,Student Name,Class,Gender,Date of Birth (YYYY-MM-DD),Parent/Guardian Name,Parent/Guardian Contact,Behavior Notes,Awards (comma-separated).</p>
                        <input type="file" id="csv-upload" accept=".csv" class="input-field mt-2">
                        <button id="import-csv-btn" class="btn-primary mt-4">Import CSV</button>
                    </div>
                `;
                 document.getElementById('add-student-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    addStudent();
                });

                document.getElementById('import-csv-btn').addEventListener('click', importStudentsFromCsv);
            }
        };

        // Centralized function to add a new student
        const addStudent = (redirect = true, studentData = null) => {
            const id = studentData ? studentData.id : document.getElementById('student-id').value;
            const name = studentData ? studentData.name : document.getElementById('student-name').value;
            const studentClass = studentData ? studentData.class : document.getElementById('student-class').value;
            const gender = studentData ? studentData.gender : document.getElementById('student-gender').value;
            const dob = studentData ? studentData.dob : document.getElementById('student-dob').value;
            const parentName = studentData ? studentData.parentName : document.getElementById('parent-name').value;
            const parentContact = studentData ? studentData.parentContact : document.getElementById('parent-contact').value;
            const behaviorNotes = studentData ? studentData.behaviorNotes : document.getElementById('behavior-notes').value;
            const awards = studentData ? studentData.awards : document.getElementById('awards').value.split(',').map(a => a.trim()).filter(a => a);

            if (!id || !name || !studentClass || !gender) {
                alert('Please fill in all required student details (Admission No., Name, Class, Gender).');
                return;
            }

            const allStudents = getData('students', []);
            const newStudent = { id, name, class: studentClass, gender, dob, parentName, parentContact, behaviorNotes, awards };

            if (allStudents.some(s => s.id === id)) {
                alert(`A student with Admission No. ${id} already exists. Skipping this entry.`);
                return;
            }

            setData('students', [...allStudents, newStudent]);
            if (redirect) {
                alert('Student added successfully!');
                renderPage(); // Reloads to the correct dashboard and shows the updated list
            }
            return true; // Indicate success for CSV import
        };

        const importStudentsFromCsv = () => {
            const fileInput = document.getElementById('csv-upload');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file to upload.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    alert('CSV file is empty.');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim());
                const expectedHeaders = ['Admission No.', 'Student Name', 'Class', 'Gender', 'Date of Birth (YYYY-MM-DD)', 'Parent/Guardian Name', 'Parent/Guardian Contact', 'Behavior Notes', 'Awards (comma-separated)'];

                if (headers.length !== expectedHeaders.length || !expectedHeaders.every(h => headers.includes(h))) {
                    alert('CSV headers do not match the expected format. Please ensure you have: ' + expectedHeaders.join(', '));
                    return;
                }

                let studentsAdded = 0;
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length !== headers.length) {
                        console.warn(`Skipping malformed row: ${lines[i]}`);
                        continue;
                    }

                    const studentData = {};
                    headers.forEach((header, index) => {
                        const value = values[index] ? values[index].trim() : '';
                        switch (header) {
                            case 'Admission No.': studentData.id = value; break;
                            case 'Student Name': studentData.name = value; break;
                            case 'Class': studentData.class = value; break;
                            case 'Gender': studentData.gender = value; break;
                            case 'Date of Birth (YYYY-MM-DD)': studentData.dob = value; break;
                            case 'Parent/Guardian Name': studentData.parentName = value; break;
                            case 'Parent/Guardian Contact': studentData.parentContact = value; break;
                            case 'Behavior Notes': studentData.behaviorNotes = value; break;
                            case 'Awards (comma-separated)': studentData.awards = value.split(',').map(a => a.trim()).filter(a => a); break;
                        }
                    });

                    if (addStudent(false, studentData)) { // Pass false to prevent immediate redirect
                        studentsAdded++;
                    }
                }
                alert(`${studentsAdded} students imported successfully!`);
                renderManageStudentsPage(); // Refresh the student list
            };
            reader.readAsText(file);
        };

        window.deleteStudent = (index) => {
            if (confirm('Are you sure you want to delete this student? All their marks and fees records will be lost.')) {
                let allStudents = getData('students', []);
                const deletedStudentId = allStudents[index].id;
                allStudents.splice(index, 1);
                setData('students', allStudents);
                // Also delete marks associated with this student
                let allMarks = getData('marks', []);
                const remainingMarks = allMarks.filter(mark => mark.studentId !== deletedStudentId);
                setData('marks', remainingMarks);
                // Also delete fees associated with this student
                let allFees = getData('fees', []);
                const remainingFees = allFees.filter(fee => fee.studentId !== deletedStudentId);
                setData('fees', remainingFees);

                alert('Student, their marks, and fees deleted successfully!');
                renderManageStudentsPage();
            }
        };

        const renderEnterMarksPage = () => {
            const students = getData('students', []);
            const subjects = [
                'Mathematics', 'English Language', 'Kiswahili', 'Physics', 'Chemistry', 'Biology',
                'History', 'Geography', 'Religious Education (CRE)', 'Business Studies', 'Agriculture',
                'Home Science', 'Art and Design', 'Computer Studies', 'French', 'German', 'Music', 'Physical Education'
            ];
            const terms = ['Term 1', 'Term 2', 'Term 3'];
            const contentDiv = document.getElementById('teacher-content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Enter Marks</h2>
                    <form id="enter-marks-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="class-select" class="block text-sm font-medium text-gray-700">Class</label>
                                <select id="class-select" class="mt-1 input-field">
                                    <option value="">Select Class</option>
                                    ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="subject-select" class="block text-sm font-medium text-gray-700">Subject</label>
                                <select id="subject-select" class="mt-1 input-field">
                                    <option value="">Select Subject</option>
                                    ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="term-select" class="block text-sm font-medium text-gray-700">Term</label>
                                <select id="term-select" class="mt-1 input-field">
                                    <option value="">Select Term</option>
                                    ${terms.map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="year-select-marks" class="block text-sm font-medium text-gray-700">Academic Year</label>
                                <select id="year-select-marks" class="mt-1 input-field">
                                    <option value="">Select Year</option>
                                    ${academicYears.map(y => `<option value="${y}" ${y === currentYear.toString() ? 'selected' : ''}>${y}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="exam-type-select" class="block text-sm font-medium text-gray-700">Exam Type</label>
                                <select id="exam-type-select" class="mt-1 input-field">
                                    <option value="">Select Exam Type</option>
                                    <option value="Mid-Term">Mid-Term</option>
                                    <option value="End of Term">End of Term</option>
                                </select>
                            </div>
                        </div>
                        <div id="marks-table-container" class="mt-6 hidden">
                            <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adm No.</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                                    </tr>
                                </thead>
                                <tbody id="marks-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Student rows will be injected here -->
                                </tbody>
                            </table>
                            <button type="submit" class="btn-primary mt-6">Save Marks</button>
                        </div>
                    </form>
                `;
                // Add event listeners for dynamic content
                const classSelect = document.getElementById('class-select');
                const marksTableContainer = document.getElementById('marks-table-container');
                const marksTableBody = document.getElementById('marks-table-body');

                classSelect.addEventListener('change', () => {
                    const selectedClass = classSelect.value;
                    if (selectedClass) {
                        const classStudents = students.filter(s => s.class === selectedClass);
                        marksTableBody.innerHTML = classStudents.map(s => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">${s.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${s.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="number" min="0" max="100" data-student-id="${s.id}" class="input-field" required>
                                </td>
                            </tr>
                        `).join('');
                        marksTableContainer.classList.remove('hidden');
                    } else {
                        marksTableContainer.classList.add('hidden');
                    }
                });

                document.getElementById('enter-marks-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveMarks();
                });
            }
        };

        const saveMarks = () => {
            const form = document.getElementById('enter-marks-form');
            const selectedClass = form['class-select'].value;
            const selectedSubject = form['subject-select'].value;
            const selectedTerm = form['term-select'].value;
            const selectedYear = form['year-select-marks'].value;
            const selectedExamType = form['exam-type-select'].value;
            const teacher = getData('session', {}).username;

            if (!selectedClass || !selectedSubject || !selectedTerm || !selectedYear || !selectedExamType) {
                alert('Please select a class, subject, term, academic year, and exam type.');
                return;
            }

            const marksInputs = document.querySelectorAll('#marks-table-body input[type="number"]');
            const allMarks = getData('marks', []);
            const allStudents = getData('students', []);
            const newMarks = [];

            marksInputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const marks = input.value;
                if (marks) {
                    const student = allStudents.find(s => s.id === studentId);
                    newMarks.push({
                        studentId: studentId,
                        studentName: student ? student.name : 'Unknown',
                        class: selectedClass,
                        subject: selectedSubject,
                        term: selectedTerm,
                        year: selectedYear,
                        examType: selectedExamType,
                        marks: parseInt(marks, 10),
                        teacher: teacher
                    });
                }
            });

            // Filter out existing marks for the same criteria (studentId, subject, term, year, examType)
            const filteredMarks = allMarks.filter(mark =>
                !(mark.class === selectedClass &&
                mark.subject === selectedSubject &&
                mark.term === selectedTerm &&
                mark.year === selectedYear &&
                mark.examType === selectedExamType)
            );

            setData('marks', [...filteredMarks, ...newMarks]);
            alert('Marks saved successfully!');
            renderPage();
        };

        const renderViewEditMarksPage = () => {
            const students = getData('students', []);
            const marks = getData('marks', []);
            const subjects = [...new Set(marks.map(m => m.subject))];
            const terms = ['Term 1', 'Term 2', 'Term 3']; // Ensure all terms are available
            const examTypes = ['Mid-Term', 'End of Term']; // Ensure all exam types are available

            const contentDiv = document.getElementById('teacher-content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">View/Edit Marks</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="class-filter" class="block text-sm font-medium text-gray-700">Class</label>
                                <select id="class-filter" class="mt-1 input-field">
                                    <option value="">All Classes</option>
                                    ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="subject-filter" class="block text-sm font-medium text-gray-700">Subject</label>
                                <select id="subject-filter" class="mt-1 input-field">
                                    <option value="">All Subjects</option>
                                    ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="term-filter" class="block text-sm font-medium text-gray-700">Term</label>
                                <select id="term-filter" class="mt-1 input-field">
                                    <option value="">All Terms</option>
                                    ${terms.map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="year-filter" class="block text-sm font-medium text-gray-700">Academic Year</label>
                                <select id="year-filter" class="mt-1 input-field">
                                    <option value="">All Years</option>
                                    ${academicYears.map(y => `<option value="${y}">${y}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="exam-type-filter" class="block text-sm font-medium text-gray-700">Exam Type</label>
                                <select id="exam-type-filter" class="mt-1 input-field">
                                    <option value="">All Exam Types</option>
                                    ${examTypes.map(e => `<option value="${e}">${e}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div id="marks-list-container" class="mt-6">
                            <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Term</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exam Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="marks-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Filtered marks will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                const marksTableBody = document.getElementById('marks-table-body');
                const filters = {
                    class: document.getElementById('class-filter'),
                    subject: document.getElementById('subject-filter'),
                    term: document.getElementById('term-filter'),
                    year: document.getElementById('year-filter'),
                    examType: document.getElementById('exam-type-filter')
                };

                const applyFilters = () => {
                    let filteredMarks = marks;
                    if (filters.class.value) {
                        filteredMarks = filteredMarks.filter(m => m.class === filters.class.value);
                    }
                    if (filters.subject.value) {
                        filteredMarks = filteredMarks.filter(m => m.subject === filters.subject.value);
                    }
                    if (filters.term.value) {
                        filteredMarks = filteredMarks.filter(m => m.term === filters.term.value);
                    }
                    if (filters.year.value) {
                        filteredMarks = filteredMarks.filter(m => m.year === filters.year.value);
                    }
                    if (filters.examType.value) {
                        filteredMarks = filteredMarks.filter(m => m.examType === filters.examType.value);
                    }

                    marksTableBody.innerHTML = filteredMarks.map((m, index) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${m.studentName}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${m.class}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${m.subject}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${m.term}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${m.year}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${m.examType}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${m.marks}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="editMark(${index})" class="text-blue-600 hover:text-blue-900 font-semibold mr-2">Edit</button>
                                <button onclick="deleteMark(${index})" class="text-red-600 hover:text-red-900 font-semibold">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                };

                // Attach event listeners for filters
                Object.values(filters).forEach(filter => {
                    filter.addEventListener('change', applyFilters);
                });

                window.editMark = (index) => {
                    const filteredMarks = marks.filter(m =>
                        (filters.class.value === '' || m.class === filters.class.value) &&
                        (filters.subject.value === '' || m.subject === filters.subject.value) &&
                        (filters.term.value === '' || m.term === filters.term.value) &&
                        (filters.year.value === '' || m.year === filters.year.value) &&
                        (filters.examType.value === '' || m.examType === filters.examType.value)
                    );
                    const markToEdit = filteredMarks[index];

                    // Find the actual index in the main 'marks' array
                    const originalIndex = marks.findIndex(m =>
                        m.studentId === markToEdit.studentId &&
                        m.subject === markToEdit.subject &&
                        m.term === markToEdit.term &&
                        m.year === markToEdit.year &&
                        m.examType === markToEdit.examType
                    );

                    const newMark = prompt(`Enter new mark for ${markToEdit.studentName} in ${markToEdit.subject} (${markToEdit.term}, ${markToEdit.year}):`, markToEdit.marks);
                    if (newMark !== null && !isNaN(newMark) && newMark >= 0 && newMark <= 100) {
                        marks[originalIndex].marks = parseInt(newMark, 10);
                        setData('marks', marks);
                        alert('Mark updated successfully!');
                        applyFilters(); // Re-render the filtered list
                    } else if (newMark !== null) {
                        alert('Invalid input. Please enter a number between 0 and 100.');
                    }
                };

                window.deleteMark = (index) => {
                    if (confirm('Are you sure you want to delete this mark?')) {
                        const filteredMarks = marks.filter(m =>
                            (filters.class.value === '' || m.class === filters.class.value) &&
                            (filters.subject.value === '' || m.subject === filters.subject.value) &&
                            (filters.term.value === '' || m.term === filters.term.value) &&
                            (filters.year.value === '' || m.year === filters.year.value) &&
                            (filters.examType.value === '' || m.examType === filters.examType.value)
                        );
                        const markToDelete = filteredMarks[index];

                        const originalIndex = marks.findIndex(m =>
                            m.studentId === markToDelete.studentId &&
                            m.subject === markToDelete.subject &&
                            m.term === markToDelete.term &&
                            m.year === markToDelete.year &&
                            m.examType === markToDelete.examType
                        );

                        if (originalIndex !== -1) {
                            marks.splice(originalIndex, 1);
                            setData('marks', marks);
                            alert('Mark deleted successfully!');
                            applyFilters();
                        }
                    }
                };

                // Initial render of the table
                applyFilters();
            }
        };
        
        const renderStudentPerformancePage = () => {
            const students = getData('students', []);
            const terms = ['Term 1', 'Term 2', 'Term 3'];
            const contentDiv = document.getElementById('teacher-content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Student Performance</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="student-select-performance" class="block text-sm font-medium text-gray-700">Select Student</label>
                            <select id="student-select-performance" class="mt-1 input-field">
                                <option value="">Select a student...</option>
                                ${students.map(s => `<option value="${s.id}">${s.name} (${s.class})</option>`).join('')}
                            </select>
                        </div>
                        <div>
                             <label for="term-select-performance" class="block text-sm font-medium text-gray-700">Select Term</label>
                             <select id="term-select-performance" class="mt-1 input-field">
                                <option value="">Select a term...</option>
                                ${terms.map(t => `<option value="${t}">${t}</option>`).join('')}
                             </select>
                        </div>
                        <div>
                             <label for="year-select-performance" class="block text-sm font-medium text-gray-700">Academic Year</label>
                             <select id="year-select-performance" class="mt-1 input-field">
                                <option value="">Select a year...</option>
                                ${academicYears.map(y => `<option value="${y}" ${y === currentYear.toString() ? 'selected' : ''}>${y}</option>`).join('')}
                             </select>
                        </div>
                    </div>
                    <div id="performance-chart-container" class="mt-6 hidden">
                        <h3 class="text-2xl font-semibold mb-4">Performance Graph (Student vs. Class Average)</h3>
                        <canvas id="performanceChart" class="bg-gray-50 p-4 rounded-lg shadow-inner"></canvas>
                        <h3 class="text-2xl font-semibold mt-8 mb-4">Subject Breakdown</h3>
                        <div id="subject-breakdown" class="space-y-4"></div>
                    </div>
                `;

                const studentSelect = document.getElementById('student-select-performance');
                const termSelect = document.getElementById('term-select-performance');
                const yearSelect = document.getElementById('year-select-performance');
                let performanceChart;

                const updatePerformance = () => {
                    const studentId = studentSelect.value;
                    const term = termSelect.value;
                    const year = yearSelect.value;
                    const chartContainer = document.getElementById('performance-chart-container');
                    const subjectBreakdownDiv = document.getElementById('subject-breakdown');

                    if (!studentId || !term || !year) {
                        chartContainer.classList.add('hidden');
                        return;
                    }

                    const allMarks = getData('marks', []);
                    const studentsInClass = getData('students', []).filter(s => {
                        const student = students.find(st => st.id === studentId);
                        return student && s.class === student.class;
                    });

                    const studentMarks = allMarks.filter(m => m.studentId === studentId && m.term === term && m.year === year);
                    const subjects = [...new Set(studentMarks.map(m => m.subject))];
                    const marks = studentMarks.map(m => m.marks);

                    if (studentMarks.length === 0) {
                        chartContainer.classList.add('hidden');
                        subjectBreakdownDiv.innerHTML = '<p class="text-center text-gray-500">No marks found for this student, term, and year.</p>';
                        return;
                    }
                    
                    // Calculate class average for each subject
                    const classAverages = subjects.map(subject => {
                        const subjectMarksInClass = allMarks.filter(m => 
                            studentsInClass.some(s => s.id === m.studentId) &&
                            m.subject === subject && m.term === term && m.year === year && m.examType === 'End of Term' // Using End of Term for class average
                        );
                        const totalSubjectMarks = subjectMarksInClass.reduce((sum, m) => sum + m.marks, 0);
                        return subjectMarksInClass.length > 0 ? (totalSubjectMarks / subjectMarksInClass.length).toFixed(2) : 0;
                    });

                    chartContainer.classList.remove('hidden');

                    if (performanceChart) {
                        performanceChart.destroy();
                    }

                    const ctx = document.getElementById('performanceChart').getContext('2d');
                    performanceChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: subjects,
                            datasets: [
                                {
                                    label: `Student Marks (${term}, ${year})`,
                                    data: marks,
                                    backgroundColor: 'rgba(59, 130, 246, 0.7)', // blue-500 with opacity
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: `Class Average (${term}, ${year})`,
                                    data: classAverages,
                                    backgroundColor: 'rgba(139, 92, 246, 0.7)', // indigo-500 with opacity
                                    borderColor: 'rgba(139, 92, 246, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Marks (%)'
                                    }
                                }
                            }
                        }
                    });

                    subjectBreakdownDiv.innerHTML = studentMarks.map(m => `
                        <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                            <h4 class="font-semibold text-lg">${m.subject}</h4>
                            <p>Marks: <span class="font-bold">${m.marks}</span></p>
                            <p>Grade: <span class="font-bold text-blue-600">${getGrade(m.marks)}</span></p>
                            <p>Exam Type: <span class="font-bold">${m.examType}</span></p>
                        </div>
                    `).join('');
                };

                studentSelect.addEventListener('change', updatePerformance);
                termSelect.addEventListener('change', updatePerformance);
                yearSelect.addEventListener('change', updatePerformance);
            }
        };

        const renderManageStudentProfilesPage = () => {
            const students = getData('students', []);
            const contentDiv = document.getElementById('teacher-content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Manage Student Profiles</h2>
                    <div class="marks-list-container mt-6">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adm No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOB</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Behavior Notes</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Awards</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body" class="bg-white divide-y divide-gray-200">
                                ${students.map((s, index) => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.class}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.gender}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.dob || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.parentName || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.parentContact || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">${s.behaviorNotes || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">${s.awards && s.awards.length > 0 ? s.awards.join(', ') : '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <button onclick="editStudentProfile(${index})" class="text-blue-600 hover:text-blue-900 font-semibold mr-2">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        };

        window.editStudentProfile = (index) => {
            let students = getData('students', []);
            const student = students[index];

            const formHtml = `
                <div id="edit-student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
                        <h3 class="text-2xl font-bold mb-6">Edit Student Profile: ${student.name}</h3>
                        <form id="edit-student-form" class="space-y-4">
                            <div>
                                <label for="edit-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                                <input type="text" id="edit-student-name" value="${student.name}" class="input-field mt-1" required>
                            </div>
                            <div>
                                <label for="edit-student-class" class="block text-sm font-medium text-gray-700">Class</label>
                                <select id="edit-student-class" class="input-field mt-1" required>
                                    ${classes.map(c => `<option value="${c}" ${student.class === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="edit-student-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                                <select id="edit-student-gender" class="input-field mt-1" required>
                                    <option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-student-dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                <input type="date" id="edit-student-dob" value="${student.dob || ''}" class="input-field mt-1">
                            </div>
                            <div>
                                <label for="edit-parent-name" class="block text-sm font-medium text-gray-700">Parent/Guardian Name</label>
                                <input type="text" id="edit-parent-name" value="${student.parentName || ''}" class="input-field mt-1">
                            </div>
                            <div>
                                <label for="edit-parent-contact" class="block text-sm font-medium text-gray-700">Parent/Guardian Contact</label>
                                <input type="text" id="edit-parent-contact" value="${student.parentContact || ''}" class="input-field mt-1">
                            </div>
                            <div>
                                <label for="edit-behavior-notes" class="block text-sm font-medium text-gray-700">Behavior Notes</label>
                                <textarea id="edit-behavior-notes" class="input-field mt-1" rows="3">${student.behaviorNotes || ''}</textarea>
                            </div>
                            <div>
                                <label for="edit-awards" class="block text-sm font-medium text-gray-700">Awards (comma-separated)</label>
                                <input type="text" id="edit-awards" value="${student.awards ? student.awards.join(', ') : ''}" class="input-field mt-1">
                            </div>
                            <div class="flex justify-end space-x-4 mt-6">
                                <button type="button" onclick="closeModal('edit-student-modal')" class="btn-primary bg-gray-500 hover:bg-gray-600">Cancel</button>
                                <button type="submit" class="btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', formHtml);

            document.getElementById('edit-student-form').addEventListener('submit', (e) => {
                e.preventDefault();
                student.name = document.getElementById('edit-student-name').value;
                student.class = document.getElementById('edit-student-class').value;
                student.gender = document.getElementById('edit-student-gender').value;
                student.dob = document.getElementById('edit-student-dob').value;
                student.parentName = document.getElementById('edit-parent-name').value;
                student.parentContact = document.getElementById('edit-parent-contact').value;
                student.behaviorNotes = document.getElementById('edit-behavior-notes').value;
                student.awards = document.getElementById('edit-awards').value.split(',').map(a => a.trim()).filter(a => a);

                setData('students', students);
                alert('Student profile updated successfully!');
                closeModal('edit-student-modal');
                renderManageStudentProfilesPage(); // Refresh the list
            });
        };

        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        };


        const renderAdminDashboard = () => {
            const students = getData('students', []);
            const teachers = getData('teachers', []);
            const marks = getData('marks', []);
            const fees = getData('fees', []);

            const totalStudents = students.length;
            const totalTeachers = teachers.length;
            const numClasses = classes.length; // Assuming 'classes' array defines all classes

            const currentAcademicYear = new Date().getFullYear().toString();
            const currentTerm = 'Term 1'; // Assuming a default current term for display

            // Calculate top student for current term/year
            const studentAverages = students.map(student => ({
                ...student,
                average: calculateStudentAverage(student.id, currentTerm, currentAcademicYear)
            })).filter(s => s.average > 0);
            studentAverages.sort((a, b) => b.average - a.average);
            const topStudent = studentAverages.length > 0 ? studentAverages[0] : null;

            // Calculate pending reports (simple logic: any student without an "End of Term" mark for current term/year)
            const studentsWithEndOfTermMarks = new Set(marks.filter(m => m.examType === 'End of Term' && m.term === currentTerm && m.year === currentAcademicYear).map(m => m.studentId));
            const pendingReportsCount = students.filter(s => !studentsWithEndOfTermMarks.has(s.id)).length;

            appContainer.innerHTML = `
                <div class="flex flex-col md:flex-row min-h-screen bg-blue-50">
                    <!-- Sidebar Navigation -->
                    <aside id="admin-sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out w-64 bg-white p-6 shadow-lg z-50 md:rounded-r-none md:rounded-l-lg rounded-lg">
                        <div class="flex items-center mb-6">
                            <img src="logo.png" alt="School Logo" class="w-10 h-10 rounded-full mr-3">
                            <span class="text-xl font-bold text-blue-600">PAAGS</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Admin Menu</h3>
                        <nav class="space-y-2">
                            <a href="#" onclick="renderAdminDashboard()" class="block nav-link bg-blue-100 text-blue-700 font-semibold">Dashboard</a>
                            <a href="#" onclick="renderManageTeachersPage()" class="block nav-link">Manage Teachers</a>
                            <a href="#" onclick="renderManageStudentsPage()" class="block nav-link">Manage Students</a>
                            <a href="#" onclick="renderFeeTrackingPage()" class="block nav-link">Fee Tracking</a>
                            <a href="#" onclick="renderFileUploadPage()" class="block nav-link">File Uploads</a>
                            <a href="#" onclick="renderExportDataPage()" class="block nav-link">Export Data</a>
                        </nav>
                        <div class="mt-8">
                             <button onclick="logout()" class="btn-primary w-full text-center">Logout</button>
                        </div>
                    </aside>

                    <!-- Overlay for mobile sidebar -->
                    <div id="admin-sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-40 hidden md:hidden" onclick="toggleSidebar('admin')"></div>

                    <!-- Main Content -->
                    <div class="flex-1 flex flex-col">
                        <!-- Mobile menu button -->
                        <button id="admin-menu-btn" class="md:hidden p-2 rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 m-4 self-start">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                        <main class="flex-1 p-6 bg-white shadow-lg rounded-lg md:rounded-l-none">
                            <div id="admin-content">
                                <h2 class="text-4xl font-bold text-gray-800 mb-2">Welcome, Admin!</h2>
                                <p class="text-gray-600 mb-6">This is your admin dashboard. Use the navigation to manage teachers and students.</p>
                                 
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                    <div class="card bg-blue-50 text-center">
                                        <h3 class="text-3xl font-bold text-blue-600">${totalStudents}</h3>
                                        <p class="text-gray-600">Total Students</p>
                                    </div>
                                    <div class="card bg-green-50 text-center">
                                        <h3 class="text-3xl font-bold text-green-600">${totalTeachers}</h3>
                                        <p class="text-gray-600">Total Teachers</p>
                                    </div>
                                    <div class="card bg-yellow-50 text-center">
                                        <h3 class="text-3xl font-bold text-yellow-600">${numClasses}</h3>
                                        <p class="text-gray-600">Total Classes</p>
                                    </div>
                                    <div class="card bg-red-50 text-center">
                                        <h3 class="text-3xl font-bold text-red-600">${pendingReportsCount}</h3>
                                        <p class="text-gray-600">Students w/ Pending Reports (${currentTerm}, ${currentAcademicYear})</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="card bg-blue-50">
                                        <h3 class="text-2xl font-semibold text-blue-600 mb-2">Manage Teachers</h3>
                                        <p class="text-gray-600">Add, edit, or remove teacher accounts.</p>
                                        <button onclick="renderManageTeachersPage()" class="btn-primary mt-4">Go to Page</button>
                                    </div>
                                    <div class="card bg-blue-50">
                                        <h3 class="text-2xl font-semibold text-blue-600 mb-2">Manage Students</h3>
                                        <p class="text-gray-600">View, add, or remove student records.</p>
                                        <button onclick="renderManageStudentsPage()" class="btn-primary mt-4">Go to Page</button>
                                    </div>
                                    <div class="card bg-blue-50">
                                        <h3 class="text-2xl font-semibold text-blue-600 mb-2">Fee Tracking</h3>
                                        <p class="text-gray-600">Track student payments and balances.</p>
                                        <button onclick="renderFeeTrackingPage()" class="btn-primary mt-4">Go to Page</button>
                                    </div>
                                    <div class="card bg-blue-50">
                                        <h3 class="text-2xl font-semibold text-blue-600 mb-2">Top Student (${currentTerm}, ${currentAcademicYear})</h3>
                                        ${topStudent ? `
                                            <p class="text-gray-600"><strong>${topStudent.name}</strong> (${topStudent.class})</p>
                                            <p class="text-gray-600">Average Score: ${topStudent.average.toFixed(2)}%</p>
                                        ` : `
                                            <p class="text-gray-600">No top student data for this term/year.</p>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            `;
            // Attach event listener for mobile menu button
            document.getElementById('admin-menu-btn').addEventListener('click', () => toggleSidebar('admin'));
        };

        const renderManageTeachersPage = () => {
            const teachers = getData('teachers', []);
            const contentDiv = document.getElementById('admin-content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Manage Teachers</h2>
                    <button onclick="renderAddTeacherForm()" class="btn-primary mb-4">Add New Teacher</button>
                    <div id="add-teacher-form-container" class="hidden card bg-gray-50 p-4 mb-4"></div>
                    <div class="marks-list-container mt-6">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teachers-table-body" class="bg-white divide-y divide-gray-200">
                                ${teachers.map((t, index) => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${t.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${t.username}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <button onclick="deleteTeacher(${index})" class="text-red-600 hover:text-red-900 font-semibold">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        };

        window.renderAddTeacherForm = () => {
            const formContainer = document.getElementById('add-teacher-form-container');
            formContainer.classList.remove('hidden');
            formContainer.innerHTML = `
                <form id="add-teacher-form" class="space-y-4">
                    <h3 class="text-xl font-bold">Add New Teacher</h3>
                    <div>
                        <label for="teacher-name" class="block text-sm font-medium text-gray-700">Teacher Name</label>
                        <input type="text" id="teacher-name" class="input-field mt-1" required>
                    </div>
                    <div>
                        <label for="teacher-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="teacher-username" class="input-field mt-1" required>
                    </div>
                    <div>
                        <label for="teacher-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="teacher-password" class="input-field mt-1" required>
                    </div>
                    <button type="submit" class="btn-primary">Save Teacher</button>
                    <button type="button" onclick="hideAddTeacherForm()" class="text-gray-500 hover:text-gray-700 font-medium ml-2">Cancel</button>
                </form>
            `;
            document.getElementById('add-teacher-form').addEventListener('submit', (e) => {
                e.preventDefault();
                addTeacher();
            });
        };

        window.hideAddTeacherForm = () => {
            document.getElementById('add-teacher-form-container').classList.add('hidden');
        };

        const addTeacher = () => {
            const name = document.getElementById('teacher-name').value;
            const username = document.getElementById('teacher-username').value;
            const password = document.getElementById('teacher-password').value;

            if (!name || !username || !password) {
                alert('All fields are required.');
                return;
            }

            const allTeachers = getData('teachers', []);
            if (allTeachers.some(t => t.username === username)) {
                alert('A teacher with this username already exists.');
                return;
            }

            const newTeacher = { name, username, password };
            setData('teachers', [...allTeachers, newTeacher]);
            alert('Teacher added successfully!');
            renderManageTeachersPage(); // Re-render the page
        };

        window.deleteTeacher = (index) => {
            if (confirm('Are you sure you want to delete this teacher?')) {
                const allTeachers = getData('teachers', []);
                allTeachers.splice(index, 1);
                setData('teachers', allTeachers);
                alert('Teacher deleted successfully!');
                renderManageTeachersPage();
            }
        };

        const renderManageStudentsPage = () => {
            const students = getData('students', []);
            const contentDiv = document.getElementById('admin-content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Manage Students</h2>
                    <button onclick="renderAddStudentPage()" class="btn-primary mb-4">Add New Student</button>
                    <div class="marks-list-container mt-6">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adm No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOB</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Behavior Notes</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Awards</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body" class="bg-white divide-y divide-gray-200">
                                ${students.map((s, index) => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.class}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.gender}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.dob || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.parentName || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.parentContact || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">${s.behaviorNotes || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">${s.awards && s.awards.length > 0 ? s.awards.join(', ') : '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <button onclick="editStudentProfile(${index})" class="text-blue-600 hover:text-blue-900 font-semibold mr-2">Edit</button>
                                            <button onclick="deleteStudent(${index})" class="text-red-600 hover:text-red-900 font-semibold">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        };
        
        // Helper function to generate a teacher comment based on average marks
        const getTeacherComment = (averageMarks) => {
            if (averageMarks >= 90) return 'An outstanding performance this term. Your dedication is truly commendable.';
            if (averageMarks >= 80) return 'A very strong performance. Continue to work hard and you will excel even further.';
            if (averageMarks >= 70) return 'A solid and commendable effort. Focus on improving a few key areas to raise your overall grade.';
            if (averageMarks >= 60) return 'A satisfactory performance. With more effort and focus, you can achieve better results.';
            return 'There is room for improvement. It is important to seek help and focus on your studies to improve your grades.';
        };
        
        // Helper function to simulate attendance data, as there is no UI to add it.
        // In a real application, this data would be fetched from a database.
        const getAttendanceData = (studentId, year) => {
            // This is mock data. In a real app, this would be stored per student per year/term.
            const seed = studentId.charCodeAt(0) + year.charCodeAt(0); // Simple seed for consistent mock data
            const totalDays = 180;
            const daysPresent = Math.floor(Math.random(seed) * (totalDays - 170) + 170); // Random from 170 to 180
            const daysAbsent = totalDays - daysPresent;
            const tardies = Math.floor(Math.random(seed * 2) * 5); // Random from 0 to 4
            return { totalDays, daysPresent, daysAbsent, tardies };
        };

        const renderGenerateReportsPage = () => {
            const students = getData('students', []);
            const terms = ['Term 1', 'Term 2', 'Term 3'];
            const contentDiv = document.getElementById('teacher-content');

            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Generate Student Reports</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="report-class-select" class="block text-sm font-medium text-gray-700">Select Class</label>
                            <select id="report-class-select" class="mt-1 input-field">
                                <option value="">Select a class...</option>
                                ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="report-term-select" class="block text-sm font-medium text-gray-700">Select Term</label>
                            <select id="report-term-select" class="mt-1 input-field">
                                <option value="">Select a term...</option>
                                ${terms.map(t => `<option value="${t}">${t}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="report-year-select" class="block text-sm font-medium text-gray-700">Academic Year</label>
                            <select id="report-year-select" class="mt-1 input-field">
                                <option value="">Select a year...</option>
                                ${academicYears.map(y => `<option value="${y}" ${y === currentYear.toString() ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="report-student-select" class="block text-sm font-medium text-gray-700">Select Student</label>
                            <select id="report-student-select" class="mt-1 input-field" disabled>
                                <option value="all">All Students</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="generate-report-btn" class="btn-primary w-full">Generate Report</button>
                        </div>
                    </div>
                    <div id="report-output-container" class="mt-8 hidden">
                        <div class="flex justify-end gap-4 mb-4 no-print">
                            <button id="download-individual-btn" class="btn-primary flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M10 2a.75.75 0 01.75.75v7.5l2.22-2.22a.75.75 0 111.06 1.06l-3.5 3.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 011.06-1.06L9.25 10.25V2.75A.75.75 0 0110 2zM5.75 12.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM5 15.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5a.75.75 0 01.75-.75zM15 15.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                                </svg>
                                Download Individual PDFs
                            </button>
                            <button id="print-pdf-btn" class="btn-primary flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                                </svg>
                                Download All as a Single PDF
                            </button>
                        </div>
                        <div id="report-preview" class="p-8 bg-white shadow-xl rounded-lg overflow-y-auto max-h-[80vh]">
                            <!-- Generated report will be inserted here -->
                        </div>
                    </div>
                `;

                const classSelect = document.getElementById('report-class-select');
                const termSelect = document.getElementById('report-term-select');
                const yearSelect = document.getElementById('report-year-select');
                const studentSelect = document.getElementById('report-student-select');
                const generateBtn = document.getElementById('generate-report-btn');
                const reportOutputContainer = document.getElementById('report-output-container');
                const reportPreview = document.getElementById('report-preview');
                const printPdfBtn = document.getElementById('print-pdf-btn');
                const downloadIndividualBtn = document.getElementById('download-individual-btn');

                // Function to generate the report HTML for a single student
                const generateSingleReportHtml = (student, allMarks, selectedTerm, selectedYear, rank, totalStudents, termAverages, annualAverage) => {
                    const marksForStudent = allMarks.filter(m => m.studentId === student.id && m.year === selectedYear);
                    const subjects = [...new Set(marksForStudent.map(m => m.subject))];
                    
                    const subjectBreakdown = subjects.map(subject => {
                        const midTermMark = marksForStudent.find(m => m.subject === subject && m.examType === 'Mid-Term' && m.term === selectedTerm);
                        const endTermMark = marksForStudent.find(m => m.subject === subject && m.examType === 'End of Term' && m.term === selectedTerm);
                        const midTermScore = midTermMark ? midTermMark.marks : null;
                        const endTermScore = endTermMark ? endTermMark.marks : null;
                        
                        let finalMark;
                        if (midTermScore !== null && endTermScore !== null) {
                            finalMark = (midTermScore + endTermScore) / 2;
                        } else {
                            finalMark = midTermScore || endTermScore;
                        }
                        
                        return {
                            subjectName: subject,
                            midTermGrade: midTermScore !== null ? `${midTermScore} (${getGrade(midTermScore)})` : '-',
                            endTermGrade: endTermScore !== null ? `${endTermScore} (${getGrade(endTermScore)})` : '-',
                            finalGrade: finalMark !== null ? `${finalMark.toFixed(0)} (${getGrade(finalMark)})` : '-'
                        };
                    });

                    const totalMarks = subjectBreakdown.filter(s => s.finalGrade !== '-').reduce((sum, s) => sum + parseFloat(s.finalGrade.split(' ')[0]), 0);
                    const averageMarks = subjectBreakdown.filter(s => s.finalGrade !== '-').length > 0 ? (totalMarks / subjectBreakdown.filter(s => s.finalGrade !== '-').length) : 0;
                    const teacherComment = getTeacherComment(averageMarks);
                    const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const attendance = getAttendanceData(student.id, selectedYear); // Get mock attendance data

                    const reportData = {
                        ...student,
                        date: today,
                        selectedTerm,
                        selectedYear,
                        subjects: subjectBreakdown,
                        totalMarks: totalMarks,
                        averageMarks: averageMarks,
                        teacherComment: teacherComment,
                        rank,
                        totalStudents,
                        attendance,
                        termAverages,
                        annualAverage
                    };

                    return `
                        <div class="report-container shadow-2xl rounded-lg">
                            <div class="report-header">
                                <img src="logo.png" alt="School Logo" class="mx-auto">
                                <h1 class="font-bold text-white">Prince Alex Academy Report Form</h1>
                                <p class="text-sm">Email: princealexdigital@gmail.com | Contact: 0717384875</p>
                            </div>
                            
                            <div class="p-6">
                                <h3 class="section-title">Student Information</h3>
                                <div class="grid grid-cols-2 gap-y-2">
                                    <p><strong>Name:</strong> ${reportData.name}</p>
                                    <p><strong>Class:</strong> ${reportData.class}</p>
                                    <p><strong>Admission No:</strong> ${reportData.id}</p>
                                    <p><strong>Date:</strong> ${reportData.date}</p>
                                    <p><strong>Term:</strong> ${reportData.selectedTerm}</p>
                                    <p><strong>Academic Year:</strong> ${reportData.selectedYear}</p>
                                    <p><strong>Position:</strong> ${reportData.rank} of ${reportData.totalStudents}</p>
                                    <p><strong>Term Average:</strong> ${reportData.averageMarks.toFixed(2)}%</p>
                                    <p><strong>Annual Average:</strong> ${reportData.annualAverage.toFixed(2)}%</p>
                                </div>
                                
                                <h3 class="section-title mt-8">Grades</h3>
                                <table class="report-table w-full mt-4">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="p-2">Subject Name</th>
                                            <th class="p-2 text-center">Mid Term Grade</th>
                                            <th class="p-2 text-center">End Term Grade</th>
                                            <th class="p-2 text-center">Final Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${reportData.subjects.map(s => `
                                            <tr class="border-b">
                                                <td class="p-2">${s.subjectName}</td>
                                                <td class="p-2 text-center">${s.midTermGrade}</td>
                                                <td class="p-2 text-center">${s.endTermGrade}</td>
                                                <td class="p-2 text-center font-bold">${s.finalGrade}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                
                                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h3 class="section-title">Grading Scale</h3>
                                        <ul class="list-disc list-inside space-y-1">
                                            <li>A: 90100%</li>
                                            <li>B: 8089%</li>
                                            <li>C: 7079%</li>
                                            <li>D: 6069%</li>
                                            <li>F: Below 60%</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h3 class="section-title">Attendance (${reportData.selectedYear})</h3>
                                        <ul class="list-inside space-y-1">
                                            <li><strong>Days Present:</strong> ${reportData.attendance.daysPresent}</li>
                                            <li><strong>Days Absent:</strong> ${reportData.attendance.daysAbsent}</li>
                                            <li><strong>Tardies:</strong> ${reportData.attendance.tardies}</li>
                                        </ul>
                                    </div>
                                </div>

                                <h3 class="section-title mt-8">Term Averages & Trends</h3>
                                <div class="grid grid-cols-3 gap-4 mt-4">
                                    ${Object.keys(reportData.termAverages).map(termKey => `
                                        <div class="p-3 bg-gray-50 rounded-lg shadow-inner">
                                            <p class="font-semibold">${termKey}:</p>
                                            <p>${reportData.termAverages[termKey].toFixed(2)}%</p>
                                        </div>
                                    `).join('')}
                                </div>

                                <h3 class="section-title mt-8">Teacher's Comment</h3>
                                <p class="mt-2 text-gray-700">${reportData.teacherComment}</p>

                                <div class="mt-12 flex justify-between items-end">
                                    <div class="text-center">
                                        <div class="signature-line"></div>
                                        <p class="mt-2 text-sm text-gray-600">Parent/Guardian Signature</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="signature-line"></div>
                                        <p class="mt-2 text-sm text-gray-600">Teacher Signature</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="signature-line"></div>
                                        <p class="mt-2 text-sm text-gray-600">Principal Signature</p>
                                    </div>
                                </div>
                            </div>
                            <div class="report-footer">
                                <p class="font-bold">Prince Alex Academy</p>
                                <p class="text-sm">Developed by Prince Alex Digital</p>
                                <p class="text-sm">Email: princealexdigital@gmail.com | Contact: 0717384875</p>
                            </div>
                        </div>
                    `;
                };

                // Event listener to populate student dropdown when class is selected
                classSelect.addEventListener('change', () => {
                    const selectedClass = classSelect.value;
                    studentSelect.innerHTML = '<option value="all">All Students</option>';
                    studentSelect.disabled = true;

                    if (selectedClass) {
                        const allStudents = getData('students', []);
                        const studentsInClass = allStudents.filter(s => s.class === selectedClass);
                        studentsInClass.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = student.name;
                            studentSelect.appendChild(option);
                        });
                        studentSelect.disabled = false;
                    }
                });

                // Generate report preview
                generateBtn.addEventListener('click', () => {
                    const selectedClass = classSelect.value;
                    const selectedTerm = termSelect.value;
                    const selectedYear = yearSelect.value;
                    const selectedStudentId = studentSelect.value;

                    if (!selectedClass || !selectedTerm || !selectedYear) {
                        alert('Please select a class, term, and academic year.');
                        return;
                    }

                    const allStudents = getData('students', []);
                    const allMarks = getData('marks', []);
                    const classStudents = allStudents.filter(s => s.class === selectedClass);
                    const totalStudents = classStudents.length;

                    // Calculate average marks and rank all students in the class for the selected term/year
                    const studentAveragesTerm = classStudents.map(student => ({
                        id: student.id,
                        average: calculateStudentAverage(student.id, selectedTerm, selectedYear)
                    })).filter(s => s.average > 0);

                    studentAveragesTerm.sort((a, b) => b.average - a.average);

                    const studentRankMap = {};
                    studentAveragesTerm.forEach((student, index) => {
                        studentRankMap[student.id] = index + 1;
                    });

                    let studentsToReport = [];
                    if (selectedStudentId === 'all') {
                        studentsToReport = classStudents;
                    } else {
                        const student = classStudents.find(s => s.id === selectedStudentId);
                        if (student) {
                            studentsToReport.push(student);
                        }
                    }

                    if (studentsToReport.length === 0) {
                        alert('No students found for the selected criteria.');
                        return;
                    }

                    // Check if marks exist for the selected class, term and year
                    const classMarksForTermAndYear = allMarks.filter(m => m.class === selectedClass && m.term === selectedTerm && m.year === selectedYear);
                    if (classMarksForTermAndYear.length === 0) {
                         alert('No marks found for this class, term, and academic year.');
                        return;
                    }

                    let reportHtml = '';
                    studentsToReport.forEach((student, index) => {
                        if (index > 0) reportHtml += '<div class="page-break"></div>';
                        const rank = studentRankMap[student.id] || 'N/A'; // Handle students with no marks
                        
                        // Calculate term-by-term averages for the annual trend
                        const studentTermAverages = {};
                        terms.forEach(term => {
                            studentTermAverages[term] = calculateStudentAverage(student.id, term, selectedYear);
                        });

                        // Calculate annual average for the student
                        let totalAnnualMarks = 0;
                        let termsWithMarks = 0;
                        Object.values(studentTermAverages).forEach(avg => {
                            if (avg > 0) {
                                totalAnnualMarks += avg;
                                termsWithMarks++;
                            }
                        });
                        const annualAverage = termsWithMarks > 0 ? totalAnnualMarks / termsWithMarks : 0;

                        reportHtml += generateSingleReportHtml(student, allMarks, selectedTerm, selectedYear, rank, totalStudents, studentTermAverages, annualAverage);
                    });
                    
                    reportPreview.innerHTML = reportHtml;
                    reportOutputContainer.classList.remove('hidden');
                });

                // Download all reports as a single PDF
                printPdfBtn.onclick = () => {
                    const selectedClass = classSelect.value;
                    const selectedTerm = termSelect.value;
                    const selectedYear = yearSelect.value;
                    if (!selectedClass || !selectedTerm || !selectedYear) {
                        alert('Please generate a report first.');
                        return;
                    }
                    html2pdf().from(reportPreview).set({
                        margin: [10, 10, 10, 10],
                        filename: `Student_Reports_${selectedClass}_${selectedTerm}_${selectedYear}.pdf`,
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    }).save();
                };

                // Download individual PDFs for all students
                downloadIndividualBtn.onclick = async () => {
                    const selectedClass = classSelect.value;
                    const selectedTerm = termSelect.value;
                    const selectedYear = yearSelect.value;
                    if (!selectedClass || !selectedTerm || !selectedYear) {
                        alert('Please select a class, term, and academic year.');
                        return;
                    }

                    const allStudents = getData('students', []);
                    const allMarks = getData('marks', []);
                    const studentsToDownload = allStudents.filter(s => s.class === selectedClass);
                    const totalStudents = studentsToDownload.length;

                    if (studentsToDownload.length === 0) {
                        alert('No students found in this class to download reports for.');
                        return;
                    }
                    
                    const classMarksForTermAndYear = allMarks.filter(m => m.class === selectedClass && m.term === selectedTerm && m.year === selectedYear);
                    if (classMarksForTermAndYear.length === 0) {
                         alert('No marks found for this class, term, and academic year.');
                        return;
                    }

                    // Calculate average marks and rank all students in the class
                    const studentAveragesTerm = studentsToDownload.map(student => ({
                        id: student.id,
                        average: calculateStudentAverage(student.id, selectedTerm, selectedYear)
                    })).filter(s => s.average > 0);
                    studentAveragesTerm.sort((a, b) => b.average - a.average);
                    const studentRankMap = {};
                    studentAveragesTerm.forEach((student, index) => {
                        studentRankMap[student.id] = index + 1;
                    });


                    const originalBtnText = downloadIndividualBtn.innerHTML;
                    downloadIndividualBtn.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Downloading...
                    `;
                    downloadIndividualBtn.disabled = true;

                    for (const student of studentsToDownload) {
                        const rank = studentRankMap[student.id] || 'N/A';
                        const studentTermAverages = {};
                        terms.forEach(term => {
                            studentTermAverages[term] = calculateStudentAverage(student.id, term, selectedYear);
                        });
                        let totalAnnualMarks = 0;
                        let termsWithMarks = 0;
                        Object.values(studentTermAverages).forEach(avg => {
                            if (avg > 0) {
                                totalAnnualMarks += avg;
                                termsWithMarks++;
                            }
                        });
                        const annualAverage = termsWithMarks > 0 ? totalAnnualMarks / termsWithMarks : 0;

                        const reportHtml = generateSingleReportHtml(student, allMarks, selectedTerm, selectedYear, rank, totalStudents, studentTermAverages, annualAverage);
                        const tempElement = document.createElement('div');
                        tempElement.innerHTML = reportHtml;

                        await html2pdf().from(tempElement).set({
                            margin: [10, 10, 10, 10],
                            filename: `Report_${student.name.replace(/\s/g, '_')}_${selectedTerm}_${selectedYear}.pdf`,
                            html2canvas: { scale: 2 },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        }).save();

                        // Add a small delay to prevent browser download manager from getting overwhelmed
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }

                    downloadIndividualBtn.innerHTML = originalBtnText;
                    downloadIndividualBtn.disabled = false;
                    alert('All individual reports have been downloaded!');
                };
            }
        };

        const renderFeeTrackingPage = () => {
            const students = getData('students', []);
            const fees = getData('fees', []);
            const terms = ['Term 1', 'Term 2', 'Term 3'];
            const contentDiv = document.getElementById('admin-content');

            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Fee Tracking</h2>
                    <div class="card bg-gray-50 p-4 mb-6">
                        <h3 class="text-xl font-bold mb-4">Record New Payment</h3>
                        <form id="record-payment-form" class="space-y-4">
                            <div>
                                <label for="fee-student-select" class="block text-sm font-medium text-gray-700">Student</label>
                                <select id="fee-student-select" class="input-field mt-1" required>
                                    <option value="">Select Student</option>
                                    ${students.map(s => `<option value="${s.id}">${s.name} (${s.class})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="fee-term-select" class="block text-sm font-medium text-gray-700">Term</label>
                                <select id="fee-term-select" class="input-field mt-1" required>
                                    <option value="">Select Term</option>
                                    ${terms.map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="fee-year-select" class="block text-sm font-medium text-gray-700">Academic Year</label>
                                <select id="fee-year-select" class="input-field mt-1" required>
                                    <option value="">Select Year</option>
                                    ${academicYears.map(y => `<option value="${y}" ${y === currentYear.toString() ? 'selected' : ''}>${y}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="amount-due" class="block text-sm font-medium text-gray-700">Amount Due</label>
                                <input type="number" id="amount-due" class="input-field mt-1" min="0" required>
                            </div>
                            <div>
                                <label for="amount-paid" class="block text-sm font-medium text-gray-700">Amount Paid</label>
                                <input type="number" id="amount-paid" class="input-field mt-1" min="0" required>
                            </div>
                            <button type="submit" class="btn-primary">Record Payment</button>
                        </form>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Payment Records</h3>
                    <div class="marks-list-container mt-6">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Term</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Due</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Paid</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fee-records-table-body" class="bg-white divide-y divide-gray-200">
                                ${fees.map((f, index) => {
                                    const student = students.find(s => s.id === f.studentId);
                                    const balance = f.amountDue - f.amountPaid;
                                    let statusColor = '';
                                    if (f.status === 'Paid') statusColor = 'text-green-600';
                                    else if (f.status === 'Partial') statusColor = 'text-yellow-600';
                                    else if (f.status === 'Pending') statusColor = 'text-red-600';

                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${student ? student.name : 'Unknown'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${f.term}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${f.year}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">$${f.amountDue.toLocaleString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">$${f.amountPaid.toLocaleString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">$${balance.toLocaleString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap ${statusColor}">${f.status}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${f.date || '-'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <button onclick="editFeeRecord(${index})" class="text-blue-600 hover:text-blue-900 font-semibold mr-2">Edit</button>
                                                <button onclick="deleteFeeRecord(${index})" class="text-red-600 hover:text-red-900 font-semibold">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('record-payment-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    recordPayment();
                });
            }
        };

        const recordPayment = () => {
            const studentId = document.getElementById('fee-student-select').value;
            const term = document.getElementById('fee-term-select').value;
            const year = document.getElementById('fee-year-select').value;
            const amountDue = parseFloat(document.getElementById('amount-due').value);
            const amountPaid = parseFloat(document.getElementById('amount-paid').value);
            const date = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

            if (!studentId || !term || !year || isNaN(amountDue) || isNaN(amountPaid)) {
                alert('Please fill in all payment details with valid numbers.');
                return;
            }

            if (amountPaid > amountDue) {
                alert('Amount paid cannot exceed amount due.');
                return;
            }

            let status = 'Pending';
            if (amountPaid === amountDue) {
                status = 'Paid';
            } else if (amountPaid > 0 && amountPaid < amountDue) {
                status = 'Partial';
            }

            const allFees = getData('fees', []);
            // Check if a record for this student, term, and year already exists
            const existingIndex = allFees.findIndex(f => f.studentId === studentId && f.term === term && f.year === year);

            if (existingIndex !== -1) {
                // Update existing record
                allFees[existingIndex] = { ...allFees[existingIndex], amountPaid: amountPaid, status: status, date: date };
            } else {
                // Add new record
                allFees.push({ studentId, term, year, amountDue, amountPaid, status, date });
            }
            
            setData('fees', allFees);
            alert('Payment recorded successfully!');
            renderFeeTrackingPage(); // Refresh the page
        };

        window.editFeeRecord = (index) => {
            let allFees = getData('fees', []);
            const feeRecord = allFees[index];
            const students = getData('students', []);
            const student = students.find(s => s.id === feeRecord.studentId);

            const newAmountPaid = prompt(`Enter new amount paid for ${student.name} (${feeRecord.term}, ${feeRecord.year}). Current paid: $${feeRecord.amountPaid.toLocaleString()}:`, feeRecord.amountPaid);
            
            if (newAmountPaid !== null && !isNaN(newAmountPaid) && parseFloat(newAmountPaid) >= 0) {
                const updatedAmountPaid = parseFloat(newAmountPaid);
                let newStatus = 'Pending';
                if (updatedAmountPaid === feeRecord.amountDue) {
                    newStatus = 'Paid';
                } else if (updatedAmountPaid > 0 && updatedAmountPaid < feeRecord.amountDue) {
                    newStatus = 'Partial';
                }

                feeRecord.amountPaid = updatedAmountPaid;
                feeRecord.status = newStatus;
                feeRecord.date = new Date().toISOString().slice(0, 10); // Update date on edit

                setData('fees', allFees);
                alert('Fee record updated successfully!');
                renderFeeTrackingPage();
            } else if (newAmountPaid !== null) {
                alert('Invalid input. Please enter a valid non-negative number.');
            }
        };

        window.deleteFeeRecord = (index) => {
            if (confirm('Are you sure you want to delete this fee record?')) {
                let allFees = getData('fees', []);
                allFees.splice(index, 1);
                setData('fees', allFees);
                alert('Fee record deleted successfully!');
                renderFeeTrackingPage();
            }
        };

        const renderFileUploadPage = () => {
            const uploadedFiles = getData('files', []);
            const contentDiv = document.getElementById('teacher-content') || document.getElementById('admin-content'); // Can be accessed by both roles

            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">File Uploads (Mock)</h2>
                    <div class="card bg-gray-50 p-4 mb-6">
                        <p class="text-red-600 mb-4 font-semibold">Note: This is a mock file upload. Files will not be permanently stored on a server, only their names/metadata will be "recorded" in your browser's local storage for demonstration purposes.</p>
                        <form id="file-upload-form" class="space-y-4">
                            <div>
                                <label for="file-input" class="block text-sm font-medium text-gray-700">Select File</label>
                                <input type="file" id="file-input" class="input-field mt-1" required>
                            </div>
                            <div>
                                <label for="file-description" class="block text-sm font-medium text-gray-700">Description</label>
                                <input type="text" id="file-description" class="input-field mt-1" placeholder="e.g., Math Assignment 1, School Notice" required>
                            </div>
                            <button type="submit" class="btn-primary">Upload File (Mock)</button>
                        </form>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Uploaded Files (Mock Records)</h3>
                    <div class="marks-list-container mt-6">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="uploaded-files-table-body" class="bg-white divide-y divide-gray-200">
                                ${uploadedFiles.map((f, index) => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${f.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${f.description}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${f.date}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <button onclick="deleteMockFile(${index})" class="text-red-600 hover:text-red-900 font-semibold">Delete Record</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('file-upload-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fileInput = document.getElementById('file-input');
                    const fileDescription = document.getElementById('file-description').value;
                    const file = fileInput.files[0];

                    if (!file || !fileDescription) {
                        alert('Please select a file and provide a description.');
                        return;
                    }

                    const newFileRecord = {
                        name: file.name,
                        description: fileDescription,
                        date: new Date().toISOString().slice(0, 10)
                    };

                    const currentFiles = getData('files', []);
                    setData('files', [...currentFiles, newFileRecord]);
                    alert('File record "uploaded" successfully (mock)!');
                    renderFileUploadPage();
                });

                window.deleteMockFile = (index) => {
                    if (confirm('Are you sure you want to delete this file record?')) {
                        let currentFiles = getData('files', []);
                        currentFiles.splice(index, 1);
                        setData('files', currentFiles);
                        alert('File record deleted!');
                        renderFileUploadPage();
                    }
                };
            }
        };

        const renderExportDataPage = () => {
            const contentDiv = document.getElementById('admin-content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Export Data</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card bg-blue-50">
                            <h3 class="text-2xl font-semibold text-blue-600 mb-2">Export Students</h3>
                            <p class="text-gray-600">Download all student records as a CSV file.</p>
                            <button onclick="exportStudentsCsv()" class="btn-primary mt-4">Export Students CSV</button>
                        </div>
                        <div class="card bg-blue-50">
                            <h3 class="text-2xl font-semibold text-blue-600 mb-2">Export Grades</h3>
                            <p class="text-gray-600">Download all student marks as a CSV file.</p>
                            <button onclick="exportGradesCsv()" class="btn-primary mt-4">Export Grades CSV</button>
                        </div>
                        <div class="card bg-blue-50">
                            <h3 class="text-2xl font-semibold text-blue-600 mb-2">Export Report Summaries</h3>
                            <p class="text-gray-600">Download summaries of all generated reports as a CSV file.</p>
                            <button onclick="exportReportSummariesCsv()" class="btn-primary mt-4">Export Report Summaries CSV</button>
                        </div>
                        <div class="card bg-blue-50">
                            <h3 class="text-2xl font-semibold text-blue-600 mb-2">Export Fee Records</h3>
                            <p class="text-gray-600">Download all fee payment records as a CSV file.</p>
                            <button onclick="exportFeesCsv()" class="btn-primary mt-4">Export Fee Records CSV</button>
                        </div>
                    </div>
                `;
            }
        };

        const downloadCsv = (filename, data) => {
            const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert(`${filename} downloaded successfully!`);
            } else {
                alert('Your browser does not support downloading files directly. Please copy the data manually.');
            }
        };

        window.exportStudentsCsv = () => {
            const students = getData('students', []);
            if (students.length === 0) {
                alert('No student data to export.');
                return;
            }
            const headers = ['Admission No.', 'Student Name', 'Class', 'Gender', 'Date of Birth (YYYY-MM-DD)', 'Parent/Guardian Name', 'Parent/Guardian Contact', 'Behavior Notes', 'Awards'];
            const csvRows = [
                headers.join(','),
                ...students.map(s => [
                    s.id,
                    s.name,
                    s.class,
                    s.gender,
                    s.dob || '',
                    s.parentName || '',
                    s.parentContact || '',
                    `"${s.behaviorNotes ? s.behaviorNotes.replace(/"/g, '""') : ''}"`, // Enclose notes in quotes
                    `"${s.awards && s.awards.length > 0 ? s.awards.join('; ').replace(/"/g, '""') : ''}"` // Enclose awards in quotes
                ].join(','))
            ];
            downloadCsv('students.csv', csvRows.join('\n'));
        };

        window.exportGradesCsv = () => {
            const marks = getData('marks', []);
            if (marks.length === 0) {
                alert('No grades data to export.');
                return;
            }
            const headers = ['Student ID', 'Student Name', 'Class', 'Subject', 'Term', 'Year', 'Exam Type', 'Marks', 'Teacher'];
            const csvRows = [
                headers.join(','),
                ...marks.map(m => [
                    m.studentId,
                    m.studentName,
                    m.class,
                    m.subject,
                    m.term,
                    m.year,
                    m.examType,
                    m.marks,
                    m.teacher
                ].join(','))
            ];
            downloadCsv('grades.csv', csvRows.join('\n'));
        };

        window.exportReportSummariesCsv = () => {
            const students = getData('students', []);
            const marks = getData('marks', []);
            const terms = ['Term 1', 'Term 2', 'Term 3'];
            
            if (students.length === 0 || marks.length === 0) {
                alert('Not enough data to export report summaries. Ensure students and marks exist.');
                return;
            }

            const headers = ['Student ID', 'Student Name', 'Class', 'Academic Year', 'Term 1 Average', 'Term 2 Average', 'Term 3 Average', 'Annual Average'];
            const csvRows = [headers.join(',')];

            students.forEach(student => {
                academicYears.forEach(year => {
                    const studentTermAverages = {};
                    let totalAnnualMarks = 0;
                    let termsWithMarks = 0;

                    terms.forEach(term => {
                        const avg = calculateStudentAverage(student.id, term, year);
                        studentTermAverages[`Term ${term.split(' ')[1]} Average`] = avg > 0 ? avg.toFixed(2) : '-';
                        if (avg > 0) {
                            totalAnnualMarks += avg;
                            termsWithMarks++;
                        }
                    });
                    const annualAverage = termsWithMarks > 0 ? (totalAnnualMarks / termsWithMarks).toFixed(2) : '-';

                    csvRows.push([
                        student.id,
                        student.name,
                        student.class,
                        year,
                        studentTermAverages['Term 1 Average'],
                        studentTermAverages['Term 2 Average'],
                        studentTermAverages['Term 3 Average'],
                        annualAverage
                    ].join(','));
                });
            });
            downloadCsv('report_summaries.csv', csvRows.join('\n'));
        };

        window.exportFeesCsv = () => {
            const fees = getData('fees', []);
            const students = getData('students', []);
            if (fees.length === 0) {
                alert('No fee records to export.');
                return;
            }

            const headers = ['Student ID', 'Student Name', 'Term', 'Year', 'Amount Due', 'Amount Paid', 'Balance', 'Status', 'Date'];
            const csvRows = [
                headers.join(','),
                ...fees.map(f => {
                    const student = students.find(s => s.id === f.studentId);
                    const studentName = student ? student.name : 'Unknown';
                    const balance = f.amountDue - f.amountPaid;
                    return [
                        f.studentId,
                        studentName,
                        f.term,
                        f.year,
                        f.amountDue,
                        f.amountPaid,
                        balance,
                        f.status,
                        f.date || ''
                    ].join(',');
                })
            ];
            downloadCsv('fee_records.csv', csvRows.join('\n'));
        };


        // --- Main Application Flow Control ---
        const renderPage = () => {
            initialSetup();
            const session = getData('session', null);
            if (!session) {
                renderLandingPage();
            } else if (session.role === 'teacher') {
                renderTeacherDashboard();
            } else if (session.role === 'admin') {
                renderAdminDashboard();
            }
        };

        // Initialize the app on window load
        window.onload = renderPage;

    </script>
</body>
</html>
